<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; }
    .task-card { background: white; border-radius: 12px; border-left: 6px solid #0d6efd; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; }
    .task-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .form-card { border-radius: 12px; border: none; }
  </style>
</head>
<body>
  <div class="container" style="max-width: 800px;">
    <h3 class="mb-4 text-primary">New Task Schedule</h3>
    
    <div class="card p-4 mb-5 shadow-sm form-card">
      <div class="row g-3">
        <div class="col-md-6"><input type="text" id="title" class="form-control" placeholder="Task Title"></div>
        <div class="col-md-6"><input type="text" id="category" class="form-control" placeholder="Category"></div>
        <div class="col-12"><textarea id="content" class="form-control" rows="2" placeholder="Email Content"></textarea></div>
        <div class="col-md-4"><input type="date" id="dueDate" class="form-control"></div>
        <div class="col-md-4"><input type="time" id="dueTime" class="form-control"></div>
        <div class="col-md-4">
          <select id="frequency" class="form-select">
            <option value="none">One-time</option>
            <option value="everyday">Every Day</option>
            <option value="everyweek">Every Week</option>
            <option value="everymonth">Every Month</option>
          </select>
        </div>
        <div class="col-12">
          <button id="submitBtn" onclick="submitTask()" class="btn btn-primary w-100 fw-bold">Save Task</button>
        </div>
      </div>
    </div>

    <h5 class="mb-3 text-secondary d-flex justify-content-between">
      Active Records <span>(Latest First)</span>
    </h5>
    <div id="taskList">Loading tasks...</div>
  </div>

  <script>
    window.onload = loadTasks;

    function loadTasks() {
      document.getElementById('taskList').innerHTML = '<div class="text-center text-muted">Refreshing list...</div>';
      google.script.run.withSuccessHandler(displayTasks).getActiveTasks();
    }

    function displayTasks(tasks) {
      const list = document.getElementById('taskList');
      if (tasks.length === 0) {
        list.innerHTML = "<div class='alert alert-light text-center'>No active tasks found.</div>";
        return;
      }
      list.innerHTML = tasks.map(t => `
        <div class="task-card p-3 d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1 fw-bold">${t.title} <span class="badge bg-light text-primary border">${t.category}</span></h6>
            <p class="mb-0 small text-muted">Due: ${t.dueDate} at ${t.dueTime} | <b>${t.frequency}</b></p>
          </div>
          <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${t.row})">Delete</button>
        </div>
      `).join('');
    }

    function submitTask() {
      const btn = document.getElementById('submitBtn');
      if(!document.getElementById('title').value) { alert("Title is required"); return; }
      
      btn.disabled = true;
      btn.innerHTML = "Saving to Sheets...";

      const data = {
        title: document.getElementById('title').value,
        content: document.getElementById('content').value,
        category: document.getElementById('category').value,
        dueDate: document.getElementById('dueDate').value,
        dueTime: document.getElementById('dueTime').value,
        frequency: document.getElementById('frequency').value
      };

      google.script.run.withSuccessHandler(() => {
        clearForm();
        loadTasks();
        btn.disabled = false;
        btn.innerHTML = "Save Task";
      }).saveTask(data);
    }

    function deleteTask(row) {
      if (confirm("Stop this schedule and archive?")) {
        google.script.run.withSuccessHandler(loadTasks).deleteTask(row);
      }
    }

    function clearForm() {
      document.querySelectorAll('input, textarea').forEach(i => i.value = '');
      document.getElementById('frequency').value = 'none';
    }
  </script>
</body>
</html>
